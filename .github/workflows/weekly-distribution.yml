name: Weekly DOJO Distribution

on:
  schedule:
    # Every Sunday at 00:00 UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:
    inputs:
      week_number:
        description: "Week number override"
        required: false
        type: string
      dry_run:
        description: "Dry run only (skip real run)"
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: "20"

permissions:
  contents: write

jobs:
  dry-run:
    name: Dry Run
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run distribution (dry run)
        env:
          CDP_API_KEY_ID: ${{ secrets.CDP_API_KEY_ID }}
          CDP_API_KEY_SECRET: ${{ secrets.CDP_API_KEY_SECRET }}
          CDP_WALLET_SECRET: ${{ secrets.CDP_WALLET_SECRET }}
          VITE_PINATA_JWT: ${{ secrets.PINATA_JWT }}
          VITE_DOJO_TOKEN_ADDRESS: ${{ secrets.DOJO_TOKEN_ADDRESS }}
          VITE_DOJO_RESOLVER_ADDRESS: ${{ secrets.DOJO_RESOLVER_ADDRESS }}
          VITE_DOJO_SCHEMA_UID: ${{ secrets.DOJO_SCHEMA_UID }}
          VITE_CHAIN_ID: ${{ secrets.CHAIN_ID }}
          NEYNAR_API_KEY: ${{ secrets.NEYNAR_API_KEY }}
          NEYNAR_SIGNER_UUID: ${{ secrets.NEYNAR_SIGNER_UUID }}
          VITE_SEKI_TOKEN_ADDRESS: ${{ secrets.SEKI_TOKEN_ADDRESS }}
          WEEK_NUMBER: ${{ github.event.inputs.week_number || '' }}
        run: node scripts/weekly-distribution/index.js --dry-run

  distribute:
    name: Run Distribution
    needs: dry-run
    if: github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run distribution
        env:
          CDP_API_KEY_ID: ${{ secrets.CDP_API_KEY_ID }}
          CDP_API_KEY_SECRET: ${{ secrets.CDP_API_KEY_SECRET }}
          CDP_WALLET_SECRET: ${{ secrets.CDP_WALLET_SECRET }}
          VITE_PINATA_JWT: ${{ secrets.PINATA_JWT }}
          VITE_DOJO_TOKEN_ADDRESS: ${{ secrets.DOJO_TOKEN_ADDRESS }}
          VITE_DOJO_RESOLVER_ADDRESS: ${{ secrets.DOJO_RESOLVER_ADDRESS }}
          VITE_DOJO_SCHEMA_UID: ${{ secrets.DOJO_SCHEMA_UID }}
          VITE_CHAIN_ID: ${{ secrets.CHAIN_ID }}
          NEYNAR_API_KEY: ${{ secrets.NEYNAR_API_KEY }}
          NEYNAR_SIGNER_UUID: ${{ secrets.NEYNAR_SIGNER_UUID }}
          VITE_SEKI_TOKEN_ADDRESS: ${{ secrets.SEKI_TOKEN_ADDRESS }}
          WEEK_NUMBER: ${{ github.event.inputs.week_number || '' }}
        run: node scripts/weekly-distribution/index.js

      - name: Commit distribution log
        if: success()
        env:
          WEEK_NUMBER: ${{ github.event.inputs.week_number || '' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add scripts/weekly-distribution/DISTRIBUTION_LOG.md public/data/distributions.json
          git diff --cached --quiet || git commit -m "chore: update distribution log (Week ${WEEK_NUMBER:-auto})"
          git push
